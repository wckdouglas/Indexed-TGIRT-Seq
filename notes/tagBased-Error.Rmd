---
title: "Tag-based Error correction"
author: "Dougals Wu"
date: "December 1, 2015"
output: html_document
---

This is a note for myself on the tag-based error correction program that I coded up. 

# Grouping

For a given read 1, the first 13 bases is the index as below.

<center>
[GGAAGAGCACACG] TCT GAA CTC CAG TCA CAC TGA TAT CTC GTA TGC CGT CTT CTG CTT GAA AAA AAA AAGG GGG G
</center>

Reads with same index are grouped together in a dictionary (python).


# Concensus base

For a cluster of reads (group), bases at a single position were extracted, concensus base was predicted using maximum likelihood.

For a give position, assume the bases A, C, T, G are observed $j, k, l, m$ times respectively.  The likelihood of the concensus base is A would be computed as:

\[
L(base = A|jA, kC, lT, mG) = P(jA, kC, lT, mG|base=A) = \prod_{b_i \in (\text{all bases})}P(b_i|base=A)
\]

\[
P(jA, kC, lT, mG|base=A) = P(A|base=A)^{j} \times P(C|base=A)^{k} \times P(T|base=A)^{l} \times P(G|base=A)^{m}
\]

And sequencing error was estimated at 0.01.

\[
P(jA, kC, lT, mG|base=A) = (1-0.01)^{j} \times 0.01^{k} \times 0.01^{l} \times 0.01^{m}
\]

Likelihood is calculated for all four base 

\[
\hat{\theta} \in \{L(base=A|jA,kC,lT,mG),L(base=T|jA,kC,lT,mG),L(base=C|jA,kC,lT,mG),L(base=G|jA,kC,lT,mG)\}
\]

likelihood ratio test was performed by:
\[
log(\Lambda) = log(\frac{max(\hat{\theta})}{\sum \hat{\theta} - max(\hat{\theta)}})
\]

If the $log(\Lambda)$ is greater than some threshold, the concensus base is determined to be the base that has maximum likelihood.

  

# log likelihood ratio threshold

```{r echo=False, message=False, warnings=False}
#!/bin/env Rscript

library(readr)
library(dplyr)
library(cowplot)

p <- read_csv('threshold.dat',col_names=c('loglik','cov','match'),col_type='nnn') %>%
    filter(match!=0) %>%
    mutate(ratio = match/cov) %>%
    filter(loglik < 10) %>%
    group_by(loglik, ratio,cov, match) %>%
    summarize(count = n()) %>%
    ggplot(aes(y= loglik, x=ratio)) +
        geom_point(alpha=0.7,aes(color=cov,size=count)) +
        scale_x_continuous(breaks=seq(0,1,0.05)) +
        scale_y_continuous(breaks=seq(0,5,0.5)) +
        theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) +
        geom_smooth(method='lm') +
        geom_hline(y=4, color='blue') +
        scale_color_gradient(high='red',low='yellow') +
        labs(x='Correct base ratio',y = 'Log likelihood ratio', color='Base coverage', size = 'Number of occurance')
p
```
